<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous" />
  <link rel="stylesheet" href="./css/geral.css" />
  <link rel="stylesheet" href="./css/index.css" />
  <title>Lista de Alunos com Filtros</title>
</head>

<body>
  <header id="main-header">
    <div class="header-container">
        <div class="logo-titulo">
            <img src="./imagem/logo-ufsm.webp" alt="Logo UFSM" class="logo-ufsm" />
            <h1>Portal Acadêmico</h1>
        </div>
        <button id="login-btn" class="btn-login">Logout</button>
    </div>
  </header>


  <main>
    <div id="container">
      <div class="titulo-container" style="justify-content: space-between; align-items: center;">
        <h2>Lista de Alunos</h2>
        <button id="abrir-modal-btn" class="btn-filtros" title="Abrir Filtros">
          <svg xmlns="http://www.w3.org/2000/svg" height="22px" viewBox="0 0 24 24" width="22px" fill="white">
            <path d="M0 0h24v24H0V0z" fill="none" />
            <path d="M2.96 2.05c-.4-.41-.12-1.05.42-1.05h17.24c.54 0 .82.64.42 1.05L14 10.46V19a1 1 0 0 1-.4.8l-4 3a1 1 0 0 1-1.6-.8v-8.54L2.96 2.05z" />
          </svg>
          Filtros
        </button>
      </div>
      <div id="media-evasao" class="mb-3 fw-bold text-center"></div>
      <div id="filtro-resumo">Exibindo todos os alunos (sem filtro aplicado)</div>

      <table>
        <thead>
          <tr>
            <th>Nome</th>
            <th>Matrícula</th>
            <th>Centro</th>
            <th>Curso</th>
            <th id="probabilidade-header">Probabilidade de Evasão</th>
          </tr>
        </thead>
        <tbody id="tabela-alunos"></tbody>
      </table>
    </div>
  </main>

  <div id="modal-overlay" class="modal-overlay">
    <div class="modal-content">
      <h3>Filtrar</h3>
    
      <div class="filtro-grupo">
        <label for="filtro-centro">Selecione o Centro Acadêmico:</label>
        <select id="filtro-centro">
          <option value="todos" selected>Todos os Centros</option>
          <option value="CET">Centro de Ciências Exatas e Tecnologia (CET)</option>
          <option value="CSH">Centro de Ciências Sociais e Humanas (CSH)</option>
          <option value="CCS">Centro de Ciências da Saúde (CCS)</option>
        </select>
      </div>

      <div class="filtro-grupo">
        <label for="filtro-curso">Selecione o Curso:</label>
        <select id="filtro-curso">
          <option value="todos" selected>Todos os Cursos</option>
        </select>
      </div>

      <div class="filtro-grupo">
        <label for="filtro-ano">Ano para exibir probabilidade de evasão:</label>
        <select id="filtro-ano">
          <option value="2021">2021</option>
          <option value="2022">2022</option>
          <option value="2023">2023</option>
          <option value="2024">2024</option>
          <option value="2025" selected>2025</option>
        </select>
      </div>

      <div class="modal-botoes">
        <button id="fechar-modal-btn">Fechar</button>
        <button id="aplicar-btn">Aplicar</button>
      </div>
    </div>
  </div>

  <script>
    const todosOsCursos = [
      "Engenharia de Software",
      "Ciência da Computação",
      "Administração",
      "Direito",
      "Medicina",
      "Arquitetura e Urbanismo",
      "Psicologia",
      "Jornalismo",
    ];

    const cursoParaCentro = {
      "Engenharia de Software": "CET",
      "Ciência da Computação": "CET",
      "Arquitetura e Urbanismo": "CET",
      "Administração": "CSH",
      "Direito": "CSH",
      "Psicologia": "CSH",
      "Jornalismo": "CSH",
      "Medicina": "CCS",
    };

    const nomes = [
      "Ana", "Bruno", "Carlos", "Daniela", "Eduardo", "Fernanda", "Gustavo",
      "Helena", "Igor", "Juliana", "Lucas", "Mariana", "Nicolas", "Olivia",
      "Pedro", "Quintino", "Rafaela", "Sergio", "Tatiana", "Vinicius"
    ];

    const sobrenomes = [
      "Silva", "Santos", "Oliveira", "Souza", "Rodrigues", "Ferreira",
      "Alves", "Pereira", "Lima", "Gomes", "Costa", "Ribeiro", "Martins", "Carvalho"
    ];

    const alunos = [];
    for (let i = 1; i <= 100; i++) {
      const nomeCompleto = `${nomes[Math.floor(Math.random() * nomes.length)]} ${sobrenomes[Math.floor(Math.random() * sobrenomes.length)]}`;
      const matricula = 2025000 + i;
      const curso = todosOsCursos[Math.floor(Math.random() * todosOsCursos.length)];
      const centro = cursoParaCentro[curso];
      const probEvasaoAnual = {};
      for (let ano = 2021; ano <= 2025; ano++) {
        probEvasaoAnual[ano] = Math.floor(Math.random() * 70) + 5;
      }
      alunos.push({ nome: nomeCompleto, matricula, centro, curso, probEvasao: probEvasaoAnual });
    }

    const tabelaAlunos = document.getElementById("tabela-alunos");
    const filtroCentro = document.getElementById("filtro-centro");
    const filtroCurso = document.getElementById("filtro-curso");
    const filtroAno = document.getElementById("filtro-ano");
    const probabilidadeHeader = document.getElementById("probabilidade-header");
    const filtroResumo = document.getElementById("filtro-resumo");
    const abrirModalBtn = document.getElementById("abrir-modal-btn");
    const modalOverlay = document.getElementById("modal-overlay");
    const aplicarBtn = document.getElementById("aplicar-btn");
    const fecharModalBtn = document.getElementById("fechar-modal-btn");
    const loginBtn = document.getElementById("login-btn");

    localStorage.setItem("bancoDeAlunos", JSON.stringify(alunos));
 
    function calcularEMostrarMedia(alunos, ano) {
      if (alunos.length === 0) {
        document.getElementById("media-evasao").textContent = "Nenhum aluno encontrado para os filtros selecionados.";
        return;
      }

  const soma = alunos.reduce((acc, aluno) => acc + aluno.probEvasao[ano], 0);
  const media = soma / alunos.length;
  const mediaFormatada = media.toFixed(2).replace('.', ',');

  document.getElementById("media-evasao").textContent = `Média de Evasão: ${mediaFormatada}%`;
}

    function popularTabela(listaAlunos, anoSelecionado) {
    tabelaAlunos.innerHTML = "";
    listaAlunos.forEach((aluno) => {
      const valor = aluno.probEvasao[anoSelecionado];
      let cor = "verde";
      if (valor >= 60) {
        cor = "vermelha";
      } else if (valor >= 30) {
        cor = "amarela";
      }

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><a href="pages/aluno.html?matricula=${aluno.matricula}">${aluno.nome}</a></td>
        <td>${aluno.matricula}</td>
        <td>${aluno.centro}</td>
        <td>${aluno.curso}</td>
        <td>
          <div class="barra-container">
            <div class="barra ${cor}" style="width: ${valor}%;"></div>
            <span class="porcentagem">${valor}%</span>
          </div>
        </td>
      `;
      tabelaAlunos.appendChild(tr);
    });
  }

    function atualizarFiltroCursos() {
      const centroSelecionado = filtroCentro.value;
      filtroCurso.innerHTML = '<option value="todos" selected>Todos os Cursos</option>';
      const cursosDisponiveis = centroSelecionado === "todos" ? todosOsCursos : todosOsCursos.filter((curso) => cursoParaCentro[curso] === centroSelecionado);
      cursosDisponiveis.forEach((curso) => {
        const option = document.createElement("option");
        option.value = curso;
        option.textContent = curso;
        filtroCurso.appendChild(option);
      });
    }

    function atualizarResumoFiltros(centro, curso, ano) {
      let texto = "Exibindo alunos";
      if (centro !== "todos") texto += ` do Centro ${centro}`;
      if (curso !== "todos") texto += `, Curso ${curso}`;
      texto += ` para o Ano ${ano}.`;
      if (centro === "todos" && curso === "todos") {
        texto = "Exibindo todos os alunos (sem filtro aplicado).";
      }
      filtroResumo.textContent = texto;
    }

    function aplicarFiltros() {
      const centroSelecionado = filtroCentro.value;
      const cursoSelecionado = filtroCurso.value;
      const anoSelecionado = filtroAno.value;
      probabilidadeHeader.textContent = `Probabilidade de Evasão (${anoSelecionado})`;

      let alunosFiltrados = alunos;
      if (centroSelecionado !== "todos") {
        alunosFiltrados = alunosFiltrados.filter((aluno) => aluno.centro === centroSelecionado);
      }
      if (cursoSelecionado !== "todos") {
        alunosFiltrados = alunosFiltrados.filter((aluno) => aluno.curso === cursoSelecionado);
      }

      popularTabela(alunosFiltrados, anoSelecionado);
      atualizarResumoFiltros(centroSelecionado, cursoSelecionado, anoSelecionado);
      calcularEMostrarMedia(alunosFiltrados, anoSelecionado);

    }

    abrirModalBtn.addEventListener("click", () => modalOverlay.classList.add("visivel"));
    fecharModalBtn.addEventListener("click", () => modalOverlay.classList.remove("visivel"));
    aplicarBtn.addEventListener("click", () => {
      aplicarFiltros();
      modalOverlay.classList.remove("visivel");
    });
    modalOverlay.addEventListener("click", (e) => {
      if (e.target === modalOverlay) modalOverlay.classList.remove("visivel");
    });

    filtroCentro.addEventListener("change", atualizarFiltroCursos);
    loginBtn.addEventListener("click", () => window.location.href = "./pages/login.html");

    atualizarFiltroCursos();
    aplicarFiltros();
  </script>
</body>
</html>
